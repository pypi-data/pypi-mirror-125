import i from"/static/logging/index.js";import a from"/static/translation/index.js";import e from"/static/security/sanitizer.js";import t from"/static/quotquot/element.js";import s from"/static/quotquot/plugins/events.js";import n from"/static/quotquot/plugins/i18n.js";import o from"/static/quotquot/plugins/style.js";import r from"/static/quotquot/plugins/class.js";import{io as d}from"/static/socket.io-client/index.js";const l=i.getLogger("ruteni.plugin.registration.element.form");l.setLevel("DEBUG");class c extends Error{constructor(i,a){super(`${i[0]} timed out after ${a} milliseconds`),this.args=i,this.timeout=a}}const u=document.createElement("template");u.innerHTML=e.sanitize('<div class="o-container o-container--xsmall u-text"><div data-class="{\'u-display-none\': state !== \'editing\'}"><form name="register"data-on-submit="submit-form"novalidate><a class="c-link"href="/"><img class="o-image u-pillar-box-super"src="/static/site/logo.svg"alt="logo"> </a><input type="hidden"name="appActionToken"value="Dlcy1HjVcD6lj2Fy3vd2Uj2FhzE64ZMj3D"> <input type="hidden"name="appAction"value="REGISTER"> <input type="hidden"name="openid.return_to"value="/somewhere"><h1 class="c-heading u-large"data-i18n="registration:create-account"></h1><div class="o-form-element"><label class="c-label"for="displayName"data-i18n="registration:your-name"></label> <input class="c-field"minlength="1"maxlength="50"autocomplete="off"id="displayName"name="displayName"required><div class="u-display-none"aria-live="assertive"role="alert"data-i18n="registration:enter-your-name"></div><div class="c-hint c-hint--static"role="tooltip"><div data-i18n="registration:empty-display-name"data-class="{\'u-display-none\': issues[\'invalid-display-name\'] !== \'empty\'}"></div><div data-i18n="registration:overflow-display-name"data-class="{\'u-display-none\': issues[\'invalid-display-name\'] !== \'overflow\'}"></div></div></div><div class="o-form-element"><label class="c-label"for="email"data-i18n="registration:email"></label> <input class="c-field"type="email"maxlength="64"id="email"name="email"required><div class="u-display-none"aria-live="assertive"role="alert"data-i18n="registration:enter-valid-email"></div><div class="c-hint c-hint--static"role="tooltip"><div data-i18n="registration:empty-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'empty\'}"></div><div data-i18n="registration:incomplete-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'incomplete\'}"></div><div data-i18n="registration:misconfigured-domain-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'misconfigured-domain\'}"></div><div data-i18n="registration:overflow-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'overflow\'}"></div><div data-i18n="registration:parse-error-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'parse-error\'}"></div><div data-i18n="registration:unknown-domain-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'unknown-domain\'}"></div></div></div><div class="o-form-element"><label class="c-label"for="password"data-i18n="registration:password"></label> <input class="c-field"type="password"minlength="8"maxlength="1024"autocomplete="off"data-i18n="[placeholder]registration:at-least-eight-characters"id="password"name="password"required><div class="u-display-none"aria-live="assertive"role="alert"data-i18n="registration:password-eight-characters"></div><div class="c-hint c-hint--static"role="tooltip"><div data-i18n="registration:empty-password"data-class="{\'u-display-none\': issues[\'invalid-password\'] !== \'empty\'}"></div><div data-i18n="registration:overflow-password"data-class="{\'u-display-none\': issues[\'invalid-password\'] !== \'overflow\'}"></div><div data-i18n="registration:weak-password"data-class="{\'u-display-none\': !(\'low-password-strength\' in issues)}"></div></div></div><div class="o-form-element"><label class="c-label"for="passwordCheck"data-i18n="registration:reenter-password"></label> <input class="c-field"type="password"minlength="8"maxlength="1024"autocomplete="off"id="passwordCheck"id="passwordCheck"name="passwordCheck"required><div class="u-display-none"aria-live="assertive"role="alert"data-i18n="registration:password-must-match"></div><div class="c-hint c-hint--static"role="tooltip"><div data-i18n="registration:password-mismatch"data-class="{\'u-display-none\': !issues[\'password-mismatch\']}"></div></div></div><div><div class="c-hint c-hint--static"role="tooltip"><div data-i18n="registration:empty-locale"data-class="{\'u-display-none\': issues[\'invalid-locale\'] !== \'empty\'}"></div><div data-i18n="registration:unknown-locale"data-class="{\'u-display-none\': issues[\'invalid-locale\'] !== \'unknown\'}"></div><div data-i18n="registration:server-timeout"data-class="{\'u-display-none\': !issues[\'server-timeout\']}"></div></div></div><div class="o-form-element"><input class="c-button c-button--block"type="submit"data-i18n="[value]registration:create-your-account"></div><div class="u-small"><span data-i18n="registration:already-have-an-account"></span> <a href="/ap/signin?openid.return_to=%2Fregistration%2Fap-signin-handler&amp;openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0"data-i18n="registration:signin"></a></div></form></div><div data-class="{\'u-display-none\': state !== \'delivered\'}"><h2 class="c-heading u-medium"data-i18n="registration:delivered"></h2><p data-i18n="registration:check-your-mailbox"data-i18n-dependencies="minutes"><form name="verify"data-on-submit="verify-code"novalidate><div><label for="displayCode"data-i18n="registration:enter-code"></label> <input class="verification-code"minlength="6"maxlength="6"autocomplete="off"id="verificationCode"code="verificationCode"required><div class="u-display-none"aria-live="assertive"role="alert"data-i18n="registration:enter-code"></div><div class="c-hint c-hint--static"role="tooltip"><div data-i18n="registration:wrong-code-length"data-class="{\'u-display-none\': false}"></div><div data-i18n="registration:wrong-code-value"data-i18n-dependencies="remaining"data-class="{\'u-display-none\': remaining}"></div><div data-i18n="registration:server-timeout"data-class="{\'u-display-none\': !issues[\'server-timeout\']}"></div></div></div><input class="c-button c-button--block"type="submit"data-i18n="[value]registration:verify-email"></form></div><div data-class="{\'u-display-none\': state !== \'delivery-failed\'}"><h4 class="c-heading u-medium"data-i18n="registration:delivery-failed"></h4><button class="c-button c-button--block"data-i18n="registration:back-home"data-on-click="back-home"></button></div><div data-class="{\'u-display-none\': state !== \'confirmed\'}"><h4 class="c-heading u-medium"data-i18n="registration:email-confirmed"></h4></div><div data-class="{\'u-display-none\': state !== \'code-expired\'}"><h4 class="c-heading u-medium"data-i18n="registration:code-expired"></h4><button class="c-button c-button--block"data-i18n="registration:back-home"data-on-click="back-home"></button></div><div data-class="{\'u-display-none\': state !== \'too-many-attempts\'}"><h4 class="c-heading u-medium"data-i18n="registration:too-many-attempts"></h4><button class="c-button c-button--block"data-i18n="registration:back-home"data-on-click="back-home"></button></div></div>');const m=["variables.host","generics.global","components.buttons","components.hints","components.inputs","components.links","objects.containers","objects.forms","objects.images","utilities.boxing","utilities.sizes","utilities.typography","utilities.visibility"].map((i=>`/static/blaze/css/${i}.css`));window.customElements.define("registration-form",class extends t{constructor(){super({template:u,state:{issues:{},state:"editing",styles:m,events:{"submit-form":i=>{i.preventDefault(),l.debug("submit-form"),this.submit().catch((i=>l.error(i)))},"verify-code":i=>{i.preventDefault(),this.verify().catch((i=>l.error(i)))},"back-home":i=>this.update({state:"editing"}).catch((i=>l.error(i)))}},Plugins:[s,n,o,r]}),this._socket=d("/ruteni/registration",{transports:["websocket"]}),this._socket.on("connect",(()=>l.debug("connected"))),this._socket.on("disconnect",(i=>l.debug("disconnected",i))),this._socket.on("connect_error",l.error)}call(i,...a){let e;return Promise.race([new Promise((i=>this._socket.emit(...a,(a=>{clearTimeout(e),i(a)})))),new Promise(((t,s)=>{e=setTimeout((()=>{const e=new c(a,i);s(e)}),i)}))])}async submit(){const i=this.$('form[name="register"]'),{displayName:e,email:t,password:s,passwordCheck:n}=i.elements;try{var o=await this.call(5e3,"edit",{display_name:e.value,email:t.value,password:s.value,locale:await a.getLanguage()})}catch(i){return i instanceof c&&await this.update({issues:{"server-timeout":!0}}),void l.error(i)}s.value!==n.value&&(o["password-mismatch"]=!0),Object.keys(o).length?await this.update({issues:o}):await this.register()}async register(){try{var i=await this.call(5e3,"register")}catch(i){return i instanceof c&&await this.update({issues:{"server-timeout":!0}}),void l.error(i)}i?await this.update({state:"delivered",minutes:i}):await this.update({state:"delivery-failed"})}async verify(){const i=this.$('form[name="verify"]'),a=i.elements.verificationCode.value;i.elements.verificationCode.value="";try{var e=await this.call(5e3,"verify",a)}catch(i){return i instanceof c&&await this.update({issues:{"server-timeout":!0}}),void l.error(i)}if(null===e){this._socket.disconnect(),await this.update({state:"confirmed"});const i=new window.CustomEvent("registered",{detail:null});this.dispatchEvent(i)}else-1===e?await this.update({state:"code-expired"}):0===e?await this.update({state:"too-many-attempts"}):e>0?await this.update({remaining:e}):l.error(e)}});
