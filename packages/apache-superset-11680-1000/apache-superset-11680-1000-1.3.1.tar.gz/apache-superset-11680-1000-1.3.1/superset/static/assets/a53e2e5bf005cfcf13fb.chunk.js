(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{4965:function(e,t,n){e.exports=n(4966)},4966:function(e,t,n){n(1151);var a=n(4967),o=n(969),i=Array.prototype,s={DOMTokenList:!0,NodeList:!0};e.exports=function(e){var t=e.entries;return e===i||e instanceof Array&&t===i.entries||s.hasOwnProperty(o(e))?a:t}},4967:function(e,t,n){var a=n(4968);e.exports=a},4968:function(e,t,n){n(1297);var a=n(257);e.exports=a("Array").entries},5044:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return W}));var a=n(62),o=n.n(a),i=n(54),s=n.n(i),l=n(26),r=n.n(l),c=n(4965),h=n.n(c),u=n(35),p=n.n(u),d=n(11),m=n.n(d),y=n(23),v=n.n(y),b=n(32),j=n.n(b),O=n(0),g=n.n(O),C=n(2),f=n.n(C),T=n(1303),S=n(45),w=n(4629),x=n(194),A=n(531),E=n(66),L=n(13),k=n(332),V=n(442),_=n(351),M=n(352),I=n(1126),N=n(451),R=n(82),F=n(1);const D={name:f.a.string,annotationType:f.a.string,sourceType:f.a.string,color:f.a.string,opacity:f.a.string,style:f.a.string,width:f.a.number,showMarkers:f.a.bool,hideLine:f.a.bool,value:f.a.oneOfType([f.a.string,f.a.number]),overrides:f.a.object,show:f.a.bool,titleColumn:f.a.string,descriptionColumns:f.a.arrayOf(f.a.string),timeColumn:f.a.string,intervalEndColumn:f.a.string,vizType:f.a.string,error:f.a.string,colorScheme:f.a.string,addAnnotationLayer:f.a.func,removeAnnotationLayer:f.a.func,close:f.a.func,onPopoverClear:f.a.func},z={name:"",annotationType:I.e,sourceType:"",color:"",opacity:"",style:"solid",width:1,showMarkers:!1,hideLine:!1,overrides:{},colorScheme:"d3Category10",show:!0,titleColumn:"",descriptionColumns:[],timeColumn:"",intervalEndColumn:"",addAnnotationLayer:()=>{},removeAnnotationLayer:()=>{},close:()=>{},onPopoverClear:()=>{}};var P={name:"1h52dri",styles:"overflow:hidden;text-overflow:ellipsis;white-space:nowrap"};class W extends g.a.PureComponent{constructor(e){var t,n,a,o,i,s,l,r,c;super(e);const{name:h,annotationType:u,sourceType:p,color:d,opacity:m,style:y,width:b,showMarkers:O,hideLine:g,value:C,overrides:f,show:T,titleColumn:S,descriptionColumns:w,timeColumn:A,intervalEndColumn:E,vizType:L}=e;("since"in f||"until"in f)&&(f.time_range=null,delete f.since,delete f.until);const k=Object(x.a)().get(L),V=(null==k?void 0:k.supportedAnnotationTypes)||[],_=j()(V).call(V,u)?u:V[0];this.state={name:h,annotationType:_,sourceType:p,value:C,overrides:f,show:T,titleColumn:S,descriptionColumns:w,timeColumn:A,intervalEndColumn:E,color:d||"",opacity:m,style:y,width:b,showMarkers:O,hideLine:g,isNew:!h,isLoadingOptions:!0,valueOptions:[]},this.submitAnnotation=v()(t=this.submitAnnotation).call(t,this),this.deleteAnnotation=v()(n=this.deleteAnnotation).call(n,this),this.applyAnnotation=v()(a=this.applyAnnotation).call(a,this),this.fetchOptions=v()(o=this.fetchOptions).call(o,this),this.handleAnnotationType=v()(i=this.handleAnnotationType).call(i,this),this.handleAnnotationSourceType=v()(s=this.handleAnnotationSourceType).call(s,this),this.handleValue=v()(l=this.handleValue).call(l,this),this.isValidForm=v()(r=this.isValidForm).call(r,this),this.popoverClearWrapper=v()(c=this.popoverClearWrapper).call(c,this)}componentDidMount(){const{annotationType:e,sourceType:t,isLoadingOptions:n}=this.state;this.fetchOptions(e,t,n)}componentDidUpdate(e,t){t.sourceType!==this.state.sourceType&&this.fetchOptions(this.state.annotationType,this.state.sourceType,!0)}getSupportedSourceTypes(e){var t,n,a,o;const i=m()(t=p()(n=h()(a=Object(x.a)()).call(a)).call(n,({value:t})=>t.canBeAnnotationType(e))).call(t,({key:e,value:t})=>({value:e,label:t.name}));return null!=(o=I.d[e])&&o.supportNativeSource&&i.unshift(I.b.NATIVE),i}isValidFormula(e,t){if(t===I.c.FORMULA)try{Object(w.a)(e).compile().evaluate({x:0})}catch(e){return!0}return!1}isValidForm(){const{name:e,annotationType:t,sourceType:n,value:a,timeColumn:o,intervalEndColumn:i}=this.state,s=[Object(A.a)(e),Object(A.a)(t),Object(A.a)(a)];return n!==I.a.NATIVE&&(t===I.c.EVENT&&s.push(Object(A.a)(o)),t===I.c.INTERVAL&&(s.push(Object(A.a)(o)),s.push(Object(A.a)(i)))),s.push(this.isValidFormula(a,t)),!p()(s).call(s,e=>e).length}popoverClearWrapper(e,t,n){n&&n(e),"clear"===(null==t?void 0:t.action)&&this.props.onPopoverClear(!0)}handleAnnotationType(e){this.setState({annotationType:e,sourceType:null,value:null})}handleAnnotationSourceType(e){const{sourceType:t}=this.state;t!==e&&this.setState({sourceType:e,value:null,isLoadingOptions:!0})}handleValue(e){this.setState({value:e,descriptionColumns:null,intervalEndColumn:null,timeColumn:null,titleColumn:null,overrides:{time_range:null}})}fetchOptions(e,t,n){n&&(t===I.a.NATIVE?E.a.get({endpoint:"/annotationlayermodelview/api/read?"}).then(({json:e})=>{var t;const n=e?m()(t=e.result).call(t,e=>({value:e.id,label:e.name})):[];this.setState({isLoadingOptions:!1,valueOptions:n})}):Object(I.f)(t)?E.a.get({endpoint:"/superset/user_slices"}).then(({json:t})=>{var n;const a=Object(x.a)();this.setState({isLoadingOptions:!1,valueOptions:m()(n=p()(t).call(t,t=>{const n=a.get(t.viz_type);return n&&n.canBeAnnotationType(e)})).call(n,e=>({value:e.id,label:e.title,slice:e}))})}):this.setState({isLoadingOptions:!1,valueOptions:[]}))}deleteAnnotation(){this.props.removeAnnotationLayer(),this.props.close()}applyAnnotation(){if(this.isValidForm()){const e=["name","annotationType","sourceType","color","opacity","style","width","showMarkers","hideLine","value","overrides","show","titleColumn","descriptionColumns","timeColumn","intervalEndColumn"],t={};r()(e).call(e,e=>{null!==this.state[e]&&(t[e]=this.state[e])}),""===t.color&&(t.color=null),this.props.addAnnotationLayer(t),this.setState({isNew:!1})}}submitAnnotation(){this.applyAnnotation(),this.props.close()}renderOption(e){return Object(F.jsx)("span",{css:P,title:e.label},e.label)}renderValueConfiguration(){const{annotationType:e,sourceType:t,value:n,valueOptions:a,isLoadingOptions:o}=this.state;let i="",s="";var l;Object(I.f)(t)?t===I.a.NATIVE?(i="Annotation layer",s="Select the Annotation Layer you would like to use."):(i=Object(L.e)("Chart"),s=`Use a pre defined Superset Chart as a source for annotations and overlays.\n        your chart must be one of these visualization types:\n        [${m()(l=this.getSupportedSourceTypes(e)).call(l,e=>e.label).join(", ")}]`):e===I.c.FORMULA&&(i="Formula",s="Expects a formula with depending time parameter 'x'\n        in milliseconds since epoch. mathjs is used to evaluate the formulas.\n        Example: '2x+5'");return Object(I.f)(t)?Object(F.jsx)(V.a,{name:"annotation-layer-value",showHeader:!0,hovered:!0,description:s,label:i,placeholder:"",options:a,isLoading:o,value:n,onChange:(e,t,n)=>this.popoverClearWrapper(e,n,this.handleValue),validationErrors:n?[]:["Mandatory"],optionRenderer:this.renderOption}):e===I.c.FORMULA?Object(F.jsx)(_.a,{name:"annotation-layer-value",hovered:!0,showHeader:!0,description:s,label:i,placeholder:"",value:n,onChange:this.handleValue,validationErrors:this.isValidFormula(n,e)?["Bad formula."]:[]}):""}renderSliceConfiguration(){const{annotationType:e,sourceType:t,value:n,valueOptions:a,overrides:i,titleColumn:l,timeColumn:r,intervalEndColumn:c,descriptionColumns:h}=this.state,{slice:u}=s()(a).call(a,e=>e.value===n)||{};if(t!==I.a.NATIVE&&u){var p,d,y,v;const t=m()(p=o()(d=u.data.groupby||[]).call(d,u.data.all_columns||[])).call(p,e=>({value:e,label:e})),n=u.data.include_time?o()(y=[{value:"__timestamp",label:"__timestamp"}]).call(y,t):t;return Object(F.jsx)("div",{style:{marginRight:"2rem"}},Object(F.jsx)(N.a,{isSelected:!0,title:Object(L.e)("Annotation Slice Configuration"),info:Object(L.e)("This section allows you to configure how to use the slice\n               to generate annotations.")},(e===I.c.EVENT||e===I.c.INTERVAL)&&Object(F.jsx)(V.a,{hovered:!0,name:"annotation-layer-time-column",label:e===I.c.INTERVAL?"Interval start column":"Event time column",description:"This column must contain date/time information.",validationErrors:r?[]:["Mandatory"],clearable:!1,options:n,value:r,onChange:e=>this.setState({timeColumn:e})}),e===I.c.INTERVAL&&Object(F.jsx)(V.a,{hovered:!0,name:"annotation-layer-intervalEnd",label:"Interval End column",description:"This column must contain date/time information.",validationErrors:c?[]:["Mandatory"],options:t,value:c,onChange:(e,t,n)=>this.popoverClearWrapper(e,n,e=>this.setState({intervalEndColumn:e}))}),Object(F.jsx)(V.a,{hovered:!0,name:"annotation-layer-title",label:"Title Column",description:"Pick a title for you annotation.",options:o()(v=[{value:"",label:"None"}]).call(v,t),value:l,onChange:(e,t,n)=>this.popoverClearWrapper(e,n,e=>this.setState({titleColumn:e}))}),e!==I.c.TIME_SERIES&&Object(F.jsx)(V.a,{hovered:!0,name:"annotation-layer-title",label:"Description Columns",description:"Pick one or more columns that should be shown in the\n                  annotation. If you don't select a column all of them will be shown.",multi:!0,options:t,value:h,onChange:(e,t,n)=>this.popoverClearWrapper(e,n,e=>this.setState({descriptionColumns:e}))}),Object(F.jsx)("div",{style:{marginTop:"1rem"}},Object(F.jsx)(M.a,{hovered:!0,name:"annotation-override-time_range",label:"Override time range",description:'This controls whether the "time_range" field from the current\n                  view should be passed down to the chart containing the annotation data.',value:"time_range"in i,onChange:e=>{delete i.time_range,e?this.setState({overrides:{...i,time_range:null}}):this.setState({overrides:{...i}})}}),Object(F.jsx)(M.a,{hovered:!0,name:"annotation-override-timegrain",label:"Override time grain",description:"This controls whether the time grain field from the current\n                  view should be passed down to the chart containing the annotation data.",value:"time_grain_sqla"in i,onChange:e=>{delete i.time_grain_sqla,delete i.granularity,e?this.setState({overrides:{...i,time_grain_sqla:null,granularity:null}}):this.setState({overrides:{...i}})}}),Object(F.jsx)(_.a,{hovered:!0,name:"annotation-layer-timeshift",label:"Time Shift",description:"Time delta in natural language\n                  (example:  24 hours, 7 days, 56 weeks, 365 days)",placeholder:"",value:i.time_shift,onChange:e=>this.setState({overrides:{...i,time_shift:e}})}))))}return""}renderDisplayConfiguration(){var e;const{color:t,opacity:n,style:a,width:i,showMarkers:l,hideLine:r,annotationType:c}=this.state,h=o()(e=Object(k.a)().get(this.props.colorScheme).colors).call(e);return t&&""!==t&&!s()(h).call(h,e=>e.toLowerCase()===t.toLowerCase())&&h.push(t),Object(F.jsx)(N.a,{isSelected:!0,title:Object(L.e)("Display configuration"),info:Object(L.e)("Configure your how you overlay is displayed here.")},Object(F.jsx)(V.a,{name:"annotation-layer-stroke",label:Object(L.e)("Style"),options:[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"longDashed",label:"Long dashed"},{value:"dotted",label:"Dotted"}],value:a,clearable:!1,onChange:e=>this.setState({style:e})}),Object(F.jsx)(V.a,{name:"annotation-layer-opacity",label:Object(L.e)("Opacity"),options:[{value:"",label:"Solid"},{value:"opacityLow",label:"0.2"},{value:"opacityMedium",label:"0.5"},{value:"opacityHigh",label:"0.8"}],value:n,onChange:(e,t,n)=>this.popoverClearWrapper(e,n,e=>this.setState({opacity:e}))}),Object(F.jsx)("div",null,Object(F.jsx)(R.a,{label:Object(L.e)("Color")}),Object(F.jsx)("div",{style:{display:"flex",flexDirection:"column"}},Object(F.jsx)(T.CompactPicker,{color:t,colors:h,onChangeComplete:e=>this.setState({color:e.hex})}),Object(F.jsx)(S.a,{style:{marginTop:"0.5rem",marginBottom:"0.5rem"},buttonStyle:""===t?"success":"default",buttonSize:"xsmall",onClick:()=>this.setState({color:""})},"Automatic Color"))),Object(F.jsx)(_.a,{name:"annotation-layer-stroke-width",label:Object(L.e)("Line width"),isInt:!0,value:i,onChange:e=>this.setState({width:e})}),c===I.c.TIME_SERIES&&Object(F.jsx)(M.a,{hovered:!0,name:"annotation-layer-show-markers",label:"Show Markers",description:"Shows or hides markers for the time series",value:l,onChange:e=>this.setState({showMarkers:e})}),c===I.c.TIME_SERIES&&Object(F.jsx)(M.a,{hovered:!0,name:"annotation-layer-hide-line",label:"Hide Line",description:"Hides the Line for the time series",value:r,onChange:e=>this.setState({hideLine:e})}))}render(){var e;const{isNew:t,name:n,annotationType:a,sourceType:o,show:i}=this.state,s=this.isValidForm(),l=Object(x.a)().get(this.props.vizType),r=l?m()(e=l.supportedAnnotationTypes).call(e,e=>I.d[e]):[],c=this.getSupportedSourceTypes(a);return Object(F.jsx)(g.a.Fragment,null,this.props.error&&Object(F.jsx)("span",{style:{color:"red"}},"ERROR: ",this.props.error),Object(F.jsx)("div",{style:{display:"flex",flexDirection:"row"}},Object(F.jsx)("div",{style:{marginRight:"2rem"}},Object(F.jsx)(N.a,{isSelected:!0,title:Object(L.e)("Layer configuration"),info:Object(L.e)("Configure the basics of your Annotation Layer.")},Object(F.jsx)(_.a,{name:"annotation-layer-name",label:Object(L.e)("Name"),placeholder:"",value:n,onChange:e=>this.setState({name:e}),validationErrors:n?[]:[Object(L.e)("Mandatory")]}),Object(F.jsx)(M.a,{name:"annotation-layer-hide",label:Object(L.e)("Hide layer"),value:!i,onChange:e=>this.setState({show:!e})}),Object(F.jsx)(V.a,{hovered:!0,description:Object(L.e)("Choose the annotation layer type"),label:Object(L.e)("Annotation layer type"),name:"annotation-layer-type",clearable:!1,options:r,value:a,onChange:this.handleAnnotationType}),c.length>0&&Object(F.jsx)(V.a,{hovered:!0,description:"Choose the source of your annotations",label:"Annotation Source",name:"annotation-source-type",options:c,value:o,onChange:(e,t,n)=>this.popoverClearWrapper(e,n,this.handleAnnotationSourceType),validationErrors:o?[]:[Object(L.e)("Mandatory")]}),this.renderValueConfiguration())),this.renderSliceConfiguration(),this.renderDisplayConfiguration()),Object(F.jsx)("div",{style:{display:"flex",justifyContent:"space-between"}},t?Object(F.jsx)(S.a,{buttonSize:"small",onClick:()=>this.props.close()},Object(L.e)("Cancel")):Object(F.jsx)(S.a,{buttonSize:"small",onClick:this.deleteAnnotation},Object(L.e)("Remove")),Object(F.jsx)("div",null,Object(F.jsx)(S.a,{buttonSize:"small",disabled:!s,onClick:this.applyAnnotation},Object(L.e)("Apply")),Object(F.jsx)(S.a,{buttonSize:"small",buttonStyle:"primary",disabled:!s,onClick:this.submitAnnotation},Object(L.e)("OK")))))}}W.propTypes=D,W.defaultProps=z}}]);