#
#OIFS standalone (=AMIP?) YAML FILE
#

# TODO:
# 1 use with_xios to include or not xios (it is not working now probably due to a bug in esm_tools - esm_tools resolving include models before resolving the chooses)

model: oifs
executable: oifs
execution_command: ${executable} -e ${oifs.input_expid}
version: 43r3
type: atmosphere
with_xios: False
xml_dir: ''

description: |
        The OpenIFS atmosphere model based on ECMWF IFS
        Carver et al., in prep.

license_text: |
        ECMWF license. AWI and GEOMAR have licenses.

# Force namelist fort.4 to be written in uppercase
namelist_case: "uppercase"

##
## Directories
##

model_dir: ${general.model_dir}
setup_dir: ${model_dir}
bin_dir: ${setup_dir}/bin
#bin_dir: ${model_dir}/bin
# seb-wahl: make focipool default until all OIFS data is available
# in the "general" pool directory
pool_dir: "${computer.pool_directories.focipool}"
input_dir: ${pool_dir}
rtables_dir: ${input_dir}/../rtables/
vtables_dir: ${input_dir}/../vtables/
clim_dir: ${input_dir}/../
icmcl_dir: ${input_dir}
icmcl_file: ICMCLgu5aINIT
forcing_dir: ${input_dir}/../${version}/ifsdata/
ifsdata_dir: ${input_dir}/../${version}/ifsdata/
namelist_dir: ${general.esm_namelist_dir}/oifs/${version}/
cmip6_data_dir: ${input_dir}/../cmip6_data
cmip5_data_dir: ${input_dir}/../cmip5_data
cmip6_data_dir_nml: ./cmip6_data/
cmip5_data_dir_nml: ./cmip5_data/
restart_dir: ""

parent_expid: "test"
parent_dir: "${pool_dir}/OPENIFS43R3-TCO95/restart/${parent_expid}"

# Default is TL159L91
# Forcing from gu5a prepIFS forcing
#
# Note: input_expid is the expid that will appear on
#       the input and forcing files in the work directory
#       prepifs_expid is the expid that appears on the
#       input and forcing files in input_dir and forcing_dir
#       Default is a TL159 run, input data from ECMWF has expid gu5a
#       but I want the expid for my run to be ECE3.

metadata:
        Name: OpenIFS
        Institute: ECMWF
        Description:
                OpenIFS provides research institutions with an easy-to-use version
                of the ECMWF IFS (Integrated Forecasting System).
        Authors: Glenn Carver (openifs-support@ecmwf.int)
        Website: https://www.ecmwf.int/en/research/projects/openifs
        License:
                Please make sure you have a licence to use OpenIFS. In case you are
                unsure, please contact redmine...

compile_infos:
        # this require currently causes esm_master install-... to not work properly
        # workaround esm_master get-... ; esm_master comp-...
        requires:
        - oasis3mct-4.0
        available_versions:
        - 40r1
        - 43r3-awi
        - 43r3-awi-e1
        - 43r3
        - 40r1-foci
        - 43r3-foci
        - 40r1-agcm
        - 43r3-v1
        choose_version:
          40r1:
            branch: foci_conserv
          "40r1-agcm":
            compile_command: export OIFS_COMP=agcm; cd make; ../fcm/bin/fcm make -v -j8 -f
              oifs-agcm.cfg
          40r1-foci:
            branch: foci_conserv
            comp_command: cd make; ../fcm/bin/fcm make -v -j24 -f oifs.cfg
            destination: 40r1
          43r3:
            branch: oifs-deck
            comp_command: export OIFS_TOPLEVEL_DIR=${model_dir}; cd make; ../fcm/bin/fcm make
              -v -j8 -f oifs.cfg ; cp -p esm/oifs/bin/master.exe esm/oifs/bin/oifs
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
          43r3-awi:
            requires:
            - oasis3mct-4.0-oifsdeck
            branch: awicm-3-deck
            comp_command: export OIFS_TOPLEVEL_DIR=${model_dir}; cd make; ../fcm/bin/fcm make
              -v -j8 -f oifs.cfg; cp -p esm/oifs/bin/master.exe esm/oifs/bin/oifs
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
            destination: oifs-43r3
          43r3-awi-e1:
            requires:
            - oasis3mct-4.0-oifsdeck
            - xios-2.5
            branch: fix-mkl
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; cp -p esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
            destination: oifs-43r3
          #43r3-foci:
          #  requires:
          #  - oasis3mct-fociagrif
          #  branch: oifs-foci
          #  comp_command: export OIFS_TOPLEVEL_DIR=${model_dir}; cd make; ../fcm/bin/fcm make
          #    -v -j8 -f oifs.cfg ; cp -p esm/oifs/bin/master.exe esm/oifs/bin/oifs
          #  git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
          #  install_bins: make/esm/oifs/bin/oifs
          43r3-foci:
            branch: oifs-geomar
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; cp -p esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-4.0
            - xios-2.5_r1910
          43r3-v1:
            branch: oifs-geomar 
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; cp -p esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-4.0
            - xios-2.5_r1910_oifs   
        clean_command: rm -rf make/esm
        comp_command: cd make; ../fcm/bin/fcm make -v -j8 -f oifs.cfg
        git-repository: https://gitlab.dkrz.de/modular_esm/oifs-40r1.git
        install_bins: make/esm/oifs/bin/master.exe
#
# Setup up compile and runtime environment i.e. what needs
# to be changed w.r.t the default config/machines/<computer>.yaml
#
#
# Setup up compile and runtime environment i.e. what needs
# to be changed w.r.t the default config/machines/<computer>.yaml
runtime_environment_changes:
  choose_computer.name:
    blogin:
      add_export_vars:
        - 'OIFS_FFIXED=""'
        - 'GRIB_SAMPLES_PATH="$ECCODESROOT/share/eccodes/ifs_samples/grib1_mlgrib2/"' 
        - 'DR_HOOK_IGNORE_SIGNALS="-1"'

    glogin:
      add_export_vars:
        - 'OIFS_FFIXED=""'
        - 'GRIB_SAMPLES_PATH="$ECCODESROOT/share/eccodes/ifs_samples/grib1_mlgrib2/"'
        - 'DR_HOOK_IGNORE_SIGNALS="-1"'

    juwels:
      add_export_vars:
        - 'OIFS_FFIXED=""'
        - 'GRIB_SAMPLES_PATH="$ECCODESROOT/share/eccodes/ifs_samples/grib1_mlgrib2/"'
        - 'DR_HOOK_IGNORE_SIGNALS="-1"'

    mistral:
      add_export_vars:
        - "GRIBAPIROOT=/sw/rhel6-x64/grib_api/grib_api-1.15.0-intel14/"
        - "UDUNITS2_ROOT=/sw/rhel6-x64/util/udunits-2.2.26-gcc64"
        - "FFTW_ROOT=/sw/rhel6-x64/numerics/fftw-3.3.7-openmp-gcc64"
        - "PROJ4_ROOT=/sw/rhel6-x64/graphics/proj4-4.9.3-gcc48"
        - "PATH=/sw/rhel6-x64/gcc/binutils-2.24-gccsys/bin:${PATH}"
        - "LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$GRIBAPIROOT/lib:$PROJ4_ROOT/lib:$FFTW_ROOT/lib"
        # ENV vars used in OIFS's source code during runtime
        - 'OIFS_FFIXED=""'
        - 'GRIB_SAMPLES_PATH="$GRIBAPIROOT/share/grib_api/ifs_samples/grib1_mlgrib2/"'

    ollie:
      add_module_actions:
        - "unload gribapi"
        - "unload hdf5"
      add_export_vars:
        - 'LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$GRIBAPIROOT:$HDF5ROOT:/home/ollie/jstreffi/ecmwf/grib_api_intel/lib"'
        - 'OIFS_FFIXED=""'
        - 'GRIB_SAMPLES_PATH="/home/ollie/jstreffi/ecmwf/grib_api_intel/share/grib_api/ifs_samples/grib1_mlgrib2"'
        - 'DR_HOOK_IGNORE_SIGNALS="-1"'


compiletime_environment_changes:
  choose_computer.name:
    blogin:
      add_export_vars:
        - "LAPACK_LIB='-mkl=sequential'"
        - "LAPACK_LIB_DEFAULT='-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential'"
        # FFTW is included in MKL so we link to that
        - "OIFS_FFTW_DIR='-L$MKLROOT/lib/intel64'"
        - "OIFS_FFTW_INCLUDE='-I$OIFS_FFTW_DIR/include/'"
        - "OIFS_FFTW_LIB='-L$OIFS_FFTW_DIR/lib/ -lmkl_intel_lp64 -lmkl_core -lmkl_sequential'"
        # TODO: figure out whether those two are still needed
        - "ESM_NETCDF_C_DIR=$NETCDFROOT"
        - "ESM_NETCDF_F_DIR=$NETCDFFROOT"
        # grib api / eccodes
        - 'OIFS_GRIB_API_INCLUDE="-I$ECCODESROOT/include"'
        - 'OIFS_GRIB_API_LIB="-L$ECCODESROOT/lib -leccodes_f90 -leccodes"'
        - 'OIFS_GRIB_INCLUDE="$OIFS_GRIB_API_INCLUDE"'
        - 'OIFS_GRIB_LIB="$OIFS_GRIB_API_LIB"'
        - 'OIFS_GRIB_API_BIN="$ECCODESROOT/bin"'
        - 'LAPACK_LIB_DEFAULT="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential"'
        # oasis
        - 'OIFS_OASIS_BASE=$(pwd)/oasis'
        - 'OIFS_OASIS_INCLUDE="-I$OIFS_OASIS_BASE/build/lib/psmile -I$OIFS_OASIS_BASE/build/lib/psmile/scrip -I$OIFS_OASIS_BASE/build/lib/psmile/mct -I$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu"'
        - 'OIFS_OASIS_LIB="-L$OIFS_OASIS_BASE/build/lib/psmile -L$OIFS_OASIS_BASE/build/lib/psmile/scrip -L$OIFS_OASIS_BASE/build/lib/psmile/mct -L$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu -lpsmile -lmct -lmpeu -lscrip"'
        # netcdf
        - 'OIFS_NETCDF_INCLUDE="-I$NETCDFROOT/include"'
        - 'OIFS_NETCDF_LIB="-L$NETCDFROOT/lib -lnetcdf"'
        - 'OIFS_NETCDFF_INCLUDE="-I$NETCDFFROOT/include"'
        - 'OIFS_NETCDFF_LIB="-L$NETCDFFROOT/lib -lnetcdff"'
        # compilers and compile switches
        - 'OIFS_FC=$FC'
        - 'OIFS_FFLAGS="-r8 -fp-model precise -align array32byte -O3 -xCORE_AVX2 -g -traceback -convert big_endian -fpe0"'
        - 'OIFS_FFIXED=""'
        - 'OIFS_FCDEFS="BLAS LITTLE LINUX INTEGER_IS_INT"'
        - 'OIFS_LFLAGS=$OIFS_MPI_LIB'
        - 'OIFS_CC=$CC'
        - 'OIFS_CFLAGS="-fp-model precise -O3 -xCORE_AVX2 -g -traceback -qopt-report=0 -fpe0"'
        - 'OIFS_CCDEFS="LINUX LITTLE INTEGER_IS_INT _ABI64 BLAS"'

    glogin:
      add_export_vars:

        - "LAPACK_LIB='-mkl=sequential'"
        - "LAPACK_LIB_DEFAULT='-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential'"
        # FFTW is included in MKL so we link to that
        - "OIFS_FFTW_DIR='-L$MKLROOT/lib/intel64'"
        - "OIFS_FFTW_INCLUDE='-I$OIFS_FFTW_DIR/include/'"
        - "OIFS_FFTW_LIB='-L$OIFS_FFTW_DIR/lib/ -lmkl_intel_lp64 -lmkl_core -lmkl_sequential'"
        # TODO: figure out whether those two are still needed
        - "ESM_NETCDF_C_DIR=$NETCDFROOT"
        - "ESM_NETCDF_F_DIR=$NETCDFFROOT"
        # grib api / eccodes
        - 'OIFS_GRIB_API_INCLUDE="-I$ECCODESROOT/include"'
        - 'OIFS_GRIB_API_LIB="-L$ECCODESROOT/lib -leccodes_f90 -leccodes"'
        - 'OIFS_GRIB_INCLUDE="$OIFS_GRIB_API_INCLUDE"'
        - 'OIFS_GRIB_LIB="$OIFS_GRIB_API_LIB"'
        - 'OIFS_GRIB_API_BIN="$ECCODESROOT/bin"'
        - 'LAPACK_LIB_DEFAULT="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential"'
        # oasis
        - 'OIFS_OASIS_BASE=$(pwd)/oasis'
        - 'OIFS_OASIS_INCLUDE="-I$OIFS_OASIS_BASE/build/lib/psmile -I$OIFS_OASIS_BASE/build/lib/psmile/scrip -I$OIFS_OASIS_BASE/build/lib/psmile/mct -I$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu"'
        - 'OIFS_OASIS_LIB="-L$OIFS_OASIS_BASE/build/lib/psmile -L$OIFS_OASIS_BASE/build/lib/psmile/scrip -L$OIFS_OASIS_BASE/build/lib/psmile/mct -L$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu -lpsmile -lmct -lmpeu -lscrip"'
        # netcdf
        - 'OIFS_NETCDF_INCLUDE="-I$NETCDFROOT/include"'
        - 'OIFS_NETCDF_LIB="-L$NETCDFROOT/lib -lnetcdf -lnetcdff"'
        - 'OIFS_NETCDFF_INCLUDE="-I$NETCDFFROOT/include"'
        - 'OIFS_NETCDFF_LIB="-L$NETCDFFROOT/lib -lnetcdff"'
        # compilers and compile switches
        - 'OIFS_FC=$FC'
        - 'OIFS_FFLAGS="-r8 -fp-model precise -align array32byte -O3 -xCORE_AVX2 -g -traceback -convert big_endian -fpe0"'
        - 'OIFS_FFIXED=""'
        - 'OIFS_FCDEFS="BLAS LITTLE LINUX INTEGER_IS_INT"'
        - 'OIFS_LFLAGS=$OIFS_MPI_LIB'
        - 'OIFS_CC=$CC'
        - 'OIFS_CFLAGS="-fp-model precise -O3 -xCORE_AVX2 -g -traceback -qopt-report=0 -fpe0"'
        - 'OIFS_CCDEFS="LINUX LITTLE INTEGER_IS_INT _ABI64 BLAS"'

    juwels:
      add_export_vars:
        # TODO: figure out whether those two are still needed
        - "ESM_NETCDF_C_DIR=$NETCDFROOT"
        - "ESM_NETCDF_F_DIR=$NETCDFFROOT"
        # grib api / eccodes
        - 'OIFS_GRIB_API_INCLUDE="-I$ECCODESROOT/include"'
        - 'OIFS_GRIB_API_LIB="-L$ECCODESROOT/lib -leccodes_f90 -leccodes"'
        - 'OIFS_GRIB_INCLUDE="$OIFS_GRIB_API_INCLUDE"'
        - 'OIFS_GRIB_LIB="$OIFS_GRIB_API_LIB"'
        - 'OIFS_GRIB_API_BIN="$ECCODESROOT/bin"'
        - 'LAPACK_LIB_DEFAULT="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential"'
        # oasis
        - 'OIFS_OASIS_BASE=$(pwd)/oasis'
        - 'OIFS_OASIS_INCLUDE="-I$OIFS_OASIS_BASE/build/lib/psmile -I$OIFS_OASIS_BASE/build/lib/psmile/scrip -I$OIFS_OASIS_BASE/build/lib/psmile/mct -I$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu"'
        - 'OIFS_OASIS_LIB="-L$OIFS_OASIS_BASE/build/lib/psmile -L$OIFS_OASIS_BASE/build/lib/psmile/scrip -L$OIFS_OASIS_BASE/build/lib/psmile/mct -L$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu -lpsmile -lmct -lmpeu -lscrip"'
        # netcdf
        - 'OIFS_NETCDF_INCLUDE="-I$NETCDFROOT/include"'
        - 'OIFS_NETCDF_LIB="-L$NETCDFROOT/lib -lnetcdf"'
        - 'OIFS_NETCDFF_INCLUDE="-I$NETCDFFROOT/include"'
        - 'OIFS_NETCDFF_LIB="-L$NETCDFFROOT/lib -lnetcdff"'
        # compilers and compile switches
        - 'OIFS_FC=$FC'
        - 'OIFS_FFLAGS="-r8 -fp-model precise -align array32byte -O3 -xCORE_AVX2 -g -traceback -convert big_endian -fpe0"'
        - 'OIFS_FFIXED=""'
        - 'OIFS_FCDEFS="BLAS LITTLE LINUX INTEGER_IS_INT"'
        - 'OIFS_LFLAGS=$OIFS_MPI_LIB'
        - 'OIFS_CC=$CC'
        - 'OIFS_CFLAGS="-fp-model precise -O3 -xCORE_AVX2 -g -traceback -qopt-report=0 -fpe0"'
        - 'OIFS_CCDEFS="LINUX LITTLE INTEGER_IS_INT _ABI64 BLAS"'

    mistral:
      add_export_vars:
        - 'MKLROOT=/sw/rhel6-x64/intel/intel-18.0.4/compilers_and_libraries_2018/linux/mkl/lib/intel64/'
        - 'LAPACK_LIB_DEFAULT="-L$MKLROOT -lmkl_intel_lp64 -lmkl_core -lmkl_sequential"'
        - "ESM_NETCDF_C_DIR=/sw/rhel6-x64/netcdf/netcdf_c-4.3.2-parallel-impi-intel14/"
        - "ESM_NETCDF_F_DIR=/sw/rhel6-x64/netcdf/netcdf_fortran-4.4.3-parallel-impi-intel14/"
        - "GRIBAPIROOT=/sw/rhel6-x64/grib_api/grib_api-1.15.0-intel14/"
        - "UDUNITS2_ROOT=/sw/rhel6-x64/util/udunits-2.2.26-gcc64"
        - "FFTW_ROOT=/sw/rhel6-x64/numerics/fftw-3.3.7-openmp-gcc64"
        - "PROJ4_ROOT=/sw/rhel6-x64/graphics/proj4-4.9.3-gcc48"
        #- "PETSC_DIR=/sw/rhel6-x64/numerics/PETSc-3.12.2-impi2018-intel18/"
        - "PATH=/sw/rhel6-x64/gcc/binutils-2.24-gccsys/bin:${PATH}"
        - "LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$GRIBAPIROOT/lib:$PROJ4_ROOT/lib:$FFTW_ROOT/lib"

        - 'GRIB_SAMPLES_PATH="$GRIBAPIROOT/share/grib_api/ifs_samples/grib1_mlgrib2/"'
        - 'PATH=$PATH:/mnt/lustre01/sw/rhel6-x64/devtools/fcm-2017.10.0/bin/'

        - 'OIFS_GRIB_API_INCLUDE="-I$GRIBAPIROOT/include"'
        - 'OIFS_GRIB_API_LIB="-L$GRIBAPIROOT/lib -lgrib_api_f90 -lgrib_api"'
        # OIFS_GRIB_API_LIB is used by OpenIFS CY40, OIFS_GRIB_LIB is used by CY43
        - 'OIFS_GRIB_INCLUDE="$OIFS_GRIB_API_INCLUDE"'
        - 'OIFS_GRIB_LIB="$OIFS_GRIB_API_LIB"'
        - 'OIFS_GRIB_API_BIN="$GRIBAPIROOT/bin"'
        - 'OIFS_OASIS_BASE=$(pwd)/oasis'
        - 'OIFS_OASIS_INCLUDE="-I$OIFS_OASIS_BASE/build/lib/psmile -I$OIFS_OASIS_BASE/build/lib/psmile/scrip -I$OIFS_OASIS_BASE/build/lib/psmile/mct -I$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu"'
        - 'OIFS_OASIS_LIB="-L$OIFS_OASIS_BASE/build/lib/psmile -L$OIFS_OASIS_BASE/build/lib/psmile/scrip -L$OIFS_OASIS_BASE/build/lib/psmile/mct -L$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu -lpsmile -lmct -lmpeu -lscrip"'
        - 'OIFS_NETCDF_INCLUDE="-I$NETCDFROOT/include"'
        - 'OIFS_NETCDF_LIB="-L$NETCDFROOT/lib -lnetcdf"'
        - 'OIFS_NETCDFF_INCLUDE="-I$NETCDFFROOT/include"'
        - 'OIFS_NETCDFF_LIB="-L$NETCDFFROOT/lib -lnetcdff"'
        - 'OIFS_FC=$FC'
        - 'OIFS_FFLAGS="-r8 -fp-model precise -align array32byte -O3 -xCORE_AVX2 -g -traceback -convert big_endian -fpe0"'
        - 'OIFS_FFIXED=""'
        - 'OIFS_FCDEFS="BLAS LITTLE LINUX INTEGER_IS_INT"'
        - 'OIFS_LFLAGS=$OIFS_MPI_LIB'
        - 'OIFS_CC=$CC'
        - 'OIFS_CFLAGS="-fp-model precise -O3 -xCORE_AVX2 -g -traceback -qopt-report=0 -fpe0"'
        - 'OIFS_CCDEFS="LINUX LITTLE INTEGER_IS_INT _ABI64 BLAS"'
        # Build OpenIFS with FFTW. Use Intel MKL interfaces
        # WARNING: FFTW does not work yet. Wait for patch from ECMWF
        # - 'OIFS_FFTW="enable"'
        - 'OIFS_FFTW_DIR="$FFTW_ROOT"'
        - 'OIFS_FFTW_INCLUDE="-I$OIFS_FFTW_DIR/include/"'
        - 'OIFS_FFTW_LIB="-L$OIFS_FFTW_DIR/lib/ -lfftw3f"'

    ollie:
      add_module_actions:
        - "unload gribapi"
        - "unload hdf5"
      add_export_vars:
        - 'LAPACK_LIB_DEFAULT="-L/global/AWIsoft/intel/2018/compilers_and_libraries_2018.5.274/linux/mkl/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential"'
        - 'LD_LIBRARY_PATH=${LD_LIBRARY_PATH:+${LD_LIBRARY_PATH}:}"/home/ollie/jstreffi/ecmwf/grib_api_intel/lib"'

        - 'GRIB_SAMPLES_PATH=/home/ollie/jstreffi/ecmwf/grib_api_intel/share/grib_api/ifs_samples/grib1_mlgrib2'

        - 'OIFS_GRIB_API_INCLUDE=-I/home/ollie/jstreffi/ecmwf/grib_api_intel/include'
        - 'OIFS_GRIB_API_LIB="-L/home/ollie/jstreffi/ecmwf/grib_api_intel/lib -lgrib_api_f90 -lgrib_api"'
        - 'OIFS_GRIB_INCLUDE=-I/home/ollie/jstreffi/ecmwf/grib_api_intel/include'
        - 'OIFS_GRIB_LIB="-L/home/ollie/jstreffi/ecmwf/grib_api_intel/lib -lgrib_api_f90 -lgrib_api"'
        - 'OIFS_GRIB_API_BIN="/home/ollie/jstreffi/ecmwf/grib_api_intel/bin"'
        - 'OIFS_GRIB_BIN="/home/ollie/jstreffi/ecmwf/grib_api_intel/bin"'
        - 'OIFS_OASIS_BASE=$(pwd)/oasis'
        - 'OIFS_OASIS_INCLUDE="-I$OIFS_OASIS_BASE/build/lib/psmile -I$OIFS_OASIS_BASE/build/lib/psmile/scrip -I$OIFS_OASIS_BASE/build/lib/psmile/mct -I$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu"'
        - 'OIFS_OASIS_LIB="-L$OIFS_OASIS_BASE/build/lib/psmile -L$OIFS_OASIS_BASE/build/lib/psmile/scrip -L$OIFS_OASIS_BASE/build/lib/psmile/mct -L$OIFS_OASIS_BASE/build/lib/psmile/mct/mpeu -lpsmile -lmct -lmpeu -lscrip"'
        - 'OIFS_NETCDF_INCLUDE=-I$NETCDF_DIR/include'
        - 'OIFS_NETCDF_LIB="-L$NETCDF_DIR/lib -lnetcdf"'
        - 'OIFS_NETCDFF_INCLUDE=-I$NETCDF_DIR/include'
        - 'OIFS_NETCDFF_LIB="-L$NETCDF_DIR/lib -lnetcdff"'
        - 'OIFS_FC=${computer.fc}'
        - 'OIFS_FFLAGS="-r8 -fp-model precise -align array32byte -O3 -qopenmp -xCORE_AVX2 -g -traceback -convert big_endian"'
        - 'OIFS_FFIXED=""'
        - 'OIFS_FCDEFS="BLAS LITTLE LINUX INTEGER_IS_INT"'
        - 'OIFS_LFLAGS='
        - 'OIFS_CC=${computer.cc}'
        - 'OIFS_CFLAGS="-fp-model precise -O3 -xCORE_AVX2 -g -traceback -qopt-report=0"'
        - 'OIFS_CCDEFS="LINUX LITTLE INTEGER_IS_INT _ABI64 BLAS"'

input_expid: ECE3
resolution: TL159
levels: L91
nlev: ${levels_number}
prepifs_expid: gu5a
prepifs_startdate: 19820101
mip: "cmip5"
scenario: "amip-prepifs"
output: "default"

wam: False
wam_2w: True
wam_step: 1
read_icmcl: 0
generate_namelist: 1
ensemble: 0
post_processing: 0
use_ocean_currents: 0

#cmip6: True
#cmip5: False
#cmip6_scenario: "pictrl"
#cmip5_scenario: 0
cmip_fix_year: 0
a4xco2: False
onepctco2: False
lhvolca: False

supercooled_liquid_could_fix: 0

# If perturb = 1, then we perturb the initial SKT in ICMGGECE3INIT
# with random numbers generated using CDO
# We use ensemble_id as seed, so this number must be unique for each member
# i.e. ensemble_id = N for r1iNp1 
perturb: 1 
ensemble_id: 1 

orb_switch: False
orb_mode: "variable_year"
orb_iyear: ${initial_date!syear} # ??? original : $(date -u -d "${run_start_date}" +%Y)

restart: 1

threads: 1
ny: 1

hours: "00"

namelists:
        - "fort.4"
        - "wam_namelist"

choose_resolution:
        # Note:
        # Tco grids only work with version 43r3.
        TCO95: 
                nx: 40320 
                ny: 1
                time_step: 3600
                oasis_grid_name: "096"
                res_number: 95
                res_number_tl: "95_4"
                truncation: "TCO"
        TL159:
                nx: 35718
                ny: 1
                time_step: 3600
                oasis_grid_name: "080"
                res_number: 159
                res_number_tl: "159l_2"
                truncation: "TL"
        TCO159:
                nx: 35718
                ny: 1
                time_step: 3600
                oasis_grid_name: "080"
                res_number: 159
                res_number_tl: "159_4"
                truncation: "TCO"
        TCO199:
                nx: 167200
                ny: 1
                time_step: 1800
                oasis_grid_name: "200"
                res_number: 199
                res_number_tl: "199_4"
                truncation: "TCO"
        TL255:
                nx: 88838
                ny: 1
                time_step: 2700
                oasis_grid_name: "128"
                res_number: 255
                res_number_tl: "255l_2"
                truncation: "TL"
        TCO319:
                nx: 421120
                ny: 1
                time_step: 1200
                oasis_grid_name: 320
                res_number: 319
                res_number_tl: "319_4"
                truncation: "TCO"
        TCO399:
                nx: 654400
                ny: 1
                time_step: 1200
                oasis_grid_name: 400
                res_number: 399
                res_number_tl: "399_4"
                truncation: "TCO"
        TL511:
                nx: 348528
                ny: 1
                time_step: 900
                oasis_grid_name: "256"
                res_number: 511
                res_number_tl: "511l_2"
                truncation: "TL"
        TL799:
                nx: 843490
                ny: 1
                time_step: 600
                oasis_grid_name: "400"
                res_number: 799
                res_number_tl: "799l_2"
                truncation: "TL"
        TL1279:
                nx: 2140702
                ny: 1
                time_step: 600
                oasis_grid_name: "640"
                res_number: 799
                res_number_tl: "1279l_2"
                truncation: "TL"

choose_computer.cores_per_node:
        24:
                nproca: 96
                nprocb: 1
        36:
                nproca: 108
                nprocb: 1
        48:
                nproca: 96
                nprocb: 1
        96:
                nproca: 96
                nprocb: 1

# Where does end_date and start_date come from
# Why is it set to 364 days even when I ask for a 5-day run
#runtime_seconds: "$(( $((${end_date} + 1days)) - ${start_date} ))"
# For a one year run, start_date = 1999-01-01T00:00:00 and next_date = 2000-01-01T00:00:00
runtime_seconds: "$(( ${next_date} - ${start_date} ))"
timestep_per_run: $((${runtime_seconds} / ${time_step}))
ndays_per_run: "$(( ${runtime_seconds} / 86400 ))" 
ndays_per_run_string: "<--format(%08d)-- ${ndays_per_run}"

seconds_since_initial: $((${start_date} - ${initial_date}))
steps_since_initial: $((${seconds_since_initial} / ${time_step}))

next_step: "$(( ${steps_since_initial} + ${timestep_per_run} ))"
steps_per_day: "$(( 86400 / ${time_step} ))"
custop: "t${oifs.next_step}"
lresume: false

start_seconds: "$((${start_date} - ${initial_date}))"
#start_ndays: "$(( ${start_seconds} / 86400 - 1 ))"
start_ndays: "$(( ${start_seconds} / 86400 ))"
start_ndays_string: "<--format(%08d)-- ${start_ndays}"
#end_seconds: "$(( $((${end_date} + 1days)) - ${initial_date}))"
next_seconds: "$((${next_date} - ${initial_date}))"
next_ndays: "$(( ${next_seconds} / 86400 ))"
next_ndays_string: "<--format(%08d)-- ${next_ndays}"

# WAMstartdate
wam_start_date: "${initial_date!syear!smonth!sday}000000"

# ICMCL start and end
icmcl_end_date: $(( ${next_date} + 1days ))
icmcl_end_date_formatted: "${icmcl_end_date!syear!smonth!sday}"

# WAM restart files are named with the number of
# days, hours, minutes, seconds since the last run
# with one time step subtracted.
# So restarting after 8 days with 30 min time step has
# time stamp 000007233000
# Here we calculate this
#
# how do we subtract one time step
#start_seconds_wam: "$(( ${start_seconds} - ${time_step} ))"
#start_ndays_wam: "$(( ${start_seconds_wam} / 86400 ))"
#start_nhours_wam: "$(( $(( ${start_seconds_wam} - $(( ${start_seconds_wam} / 86400 )) * 86400 )) / 3600 ))"
#start_remaining_seconds: "$(( ${start_seconds_wam} - $(( ${start_nhours_wam} * 3600 )) - $(( ${start_ndays_wam} * 86400 )) ))"
#start_nmins_wam: "$(( ${start_remaining_seconds} / 60 ))"
#start_ndays_string_wam: "<--format(%06d)-- ${start_ndays_wam}"
#start_nhour_string_wam: "<--format(%02d)-- ${start_nhours_wam}"
#start_nmins_string_wam: "<--format(%02d)-- ${start_nmins_wam}"
#start_timestamp_wam: "${start_ndays_string_wam}${start_nhour_string_wam}${start_nmins_wam}"
#start_filebase_wam: "${initial_date!syear!smonth!sday!shour!sminute!ssecond}_${start_timestamp_wam}"
start_filebase_wam: "${initial_date!syear!smonth!sday}000000_0000000000"

#end_seconds_wam: "$(( ${end_date} - ${initial_date} - ${time_step} ))"
#end_ndays_wam: "$(( ${end_seconds_wam} / 86400 ))"
#end_nhours_wam: "$(( $(( ${end_seconds_wam} - $(( ${end_seconds_wam} / 86400 )) * 86400 )) / 3600 ))"
#end_remaining_seconds: "$(( ${end_seconds_wam} - $(( ${end_nhours_wam} * 3600 )) - $(( ${end_ndays_wam} * 86400 )) ))"
#end_nmins_wam: "$(( ${end_remaining_seconds} / 60 ))"
#end_ndays_string_wam: "<--format(%06d)-- ${end_ndays_wam}"
#end_nhour_string_wam: "<--format(%02d)-- ${end_nhours_wam}"
#end_nmins_string_wam: "<--format(%02d)-- ${end_nmins_wam}"
#end_timestamp_wam: "${end_ndays_string_wam}${end_nhour_string_wam}${end_nmins_wam}"
#end_filebase_wam: "${initial_date!syear!smonth!sday!shour!sminute!ssecond}_${start_timestamp_wam}"
end_filebase_wam: "${initial_date!syear!smonth!sday}000000_0000000000"

run_number_minus1: "$(( ${run_number} - 1 ))"
run_number_string: "<--format(%05d)-- ${run_number}"
run_number_minus1_string: "<--format(%05d)-- ${run_number_minus1}"


restart_rate: 1
restart_unit: "months"

oasis_grid_name_a: "A${oasis_grid_name}"
oasis_grid_name_r: "R${oasis_grid_name}"
oasis_grid_name_l: "L${oasis_grid_name}"


choose_levels:
        L60:
                levels_number: 60
        L62:
                levels_number: 62
        L91:
                levels_number: 91
        L137:
                levels_number: 137

bin_sources:
        bin: ${bin_dir}/${executable}

##
## input files
##

input_files:
        #ICMGG_INIT: ICMGG_INIT
        #ICMGG_INIUA: ICMGG_INIUA
        #ICMSH_INIT: ICMSH_INIT
        ifsdata: ifsdata
        rtables: rtables
        vtables: vtables
        tl_data: tl_data
        o3_data: o3_data
        # also missing: modify_init for ensemble stuff

##
## forcing files
##

##
## log files
##

log_files:
        NODE: NODE
        ifsstat: ifsstat

log_sources:
        NODE: NODE.001_01
        ifsstat: ifs.stat

log_in_work:
        NODE: NODE.001_01
        ifsstat: ifs.stat

# 
# Restart file - input
# 
restart_in_files:
        srf: srf
        rcf: rcf

restart_in_in_work:
        rcf: rcf

restart_in_sources:
        srf: srf${start_ndays_string}0000.*
        rcf: rcf${start_ndays_string}
        BLS: BLS${start_filebase_wam}.*
        LAW: LAW${start_filebase_wam}.*

# 
# Restart file - output
# 
restart_out_files:
        srf: srf
        rcf: rcf

restart_out_sources:
        srf: srf${next_ndays_string}0000.*
        rcf: rcf
        BLS: BLS${end_filebase_wam}.*
        LAW: LAW${end_filebase_wam}.*

restart_out_targets:
        rcf: rcf${next_ndays_string}
##
## output
##

outdata_in_work:
        ICMGG: ICMGG${oifs.input_expid}+*
        ICMSH: ICMSH${oifs.input_expid}+*
        ICMUA: ICMUA${oifs.input_expid}+*
        MPP: MPP*
#        # XIOS output
        oifsnc: ${input_expid}_*_${start_date!syear!smonth!sday}_*.nc

outdata_sources:
        # old grib based output
        ICMGG: ICMGG${oifs.input_expid}+*
        ICMSH: ICMSH${oifs.input_expid}+*
        ICMUA: ICMUA${oifs.input_expid}+*
        MPP: MPP*
        # XIOS output
        oifsnc: ${input_expid}_*_${start_date!syear!smonth!sday}_*.nc

## Using XIOS?
choose_with_xios:
        1:
                include_models:
                        - xios
                add_namelist_changes: 
                        fort.4:
                                NAMCT0:
                                        LXIOS: ".true."
                outdata_files:
                        oifsnc: oifsnc
        0:               
                outdata_files:
                        ICMGG: ICMGG
                        ICMSH: ICMSH



##
## would that we with or without ECWAM, sir?
##

choose_wam:
        1:
                wam_number: "1"

                add_input_files:
                        wam_grid_tables: wam_grid_tables
                        wam_subgrid_0: wam_subgrid_0
                        wam_subgrid_1: wam_subgrid_1
                        wam_subgrid_2: wam_subgrid_2
                        #uwavein: uwavein
                        #specwavein: specwavein
                        #sfcwindin: sfcwindin
                        #cdwavein: cdwavein

                add_namelist_changes:
                        fort.4:
                                NAEPHY:
                                        LWCOU: ".true."
                                        LWCOU2W: ".true."
                        wam_namelist:
                                NALINE:
                                        CDATEF: "${wam_start_date}"

                add_restart_in_files:
                        BLS: BLS
                        LAW: LAW
                add_restart_out_files:
                        BLS: BLS
                        LAW: LAW

                add_outdata_files:
                        MPP: MPP

                add_config_sources:
                        "wam_namelist": "${namelist_dir}/wam_namelist"

        0:
                wam_number: "0"

                add_namelist_changes:
                        fort.4:
                                NAEPHY:
                                        LWCOU: ".false."
                                        LWCOU2W: ".false."

# For coupled setups we can use ocean currents 
choose_use_ocean_currents:
        1: 
                add_namelist_changes:
                        fort.4:
                                NAEPHY: 
                                        LECURR: ".true."
        0:
                add_namelist_changes:
                        fort.4:
                                NAEPHY:
                                        LECURR: ".false."

##
## specifics for 40r1 and 43r3
##

choose_version:
        40r1:
                add_namelist_changes:
                        fort.4:
                                NAMRES:
                                        #NFRRES: ${oifs.next_step}
                                        NFRRES: 1
                                        NRESTS: "-1, -${oifs.next_step}"

                                NAMPAR0:
                                        NPROC: ${oifs.nproca}

                                NAMDYN:
                                        TSTEP: ${oifs.time_step}

                                NAMCT0:
                                        CNMEXP: ${oifs.input_expid}
                                        NSTOP: ${oifs.next_step}

                                NAMFOCICFG:
                                        # By default, turn off coupling
                                        FOCI_CPL_NEMO_LIM: ".false."

                environment_changes:
                        add_export_vars:
                                - 'OIFS_FFIXED="-fixed"'
                                - 'DR_HOOK_IGNORE_SIGNALS="-1"'
                                - 'OIFS_EXPID="${input_expid}"'
                                - 'FOCI_USE_CPLNG="no"'
                                - 'FESOM_USE_CPLNG="no"'
                                - 'ECE_USE_CPLNG="no"'

        43r3:
                add_namelist_changes:
                        fort.4:
                                NAMRES:
                                        #NFRRES: ${timestep_per_run} #${oifs.next_step}
                                        NFRRES: ${oifs.next_step} 
                                        #NRESTS(1): -1
                                        #NRESTS(2): -${oifs.next_step} #-${timestep_per_run}

                                NAMPAR0:
                                        NPROC: ${oifs.nproca}

                                NAMARG:
                                        UTSTEP: ${oifs.time_step}
                                        CNMEXP: "${oifs.input_expid}"
                                        CUSTOP: "${custop}"
                                NAMPPC:
                                        LRSACC: ".true." # reset accumulation of fluxes

                add_outdata_files:
                        ICMUA: ICMUA


##
## specifics for scenarios
##

# NOTE: We can only have one choose_mip
# Therefore, we must put choose_scenario under this choose_mip
# If one yaml file has two choose_mip, I think the code will only
# evaluate one of the branches
# NOTE 2: Im leaving CMIP5 in here, but I dont think we will ever use it

choose_mip:
        "cmip5":
                add_forcing_files:
                        PRE2005_MIDYR_CONC: PRE2005_MIDYR_CONC
                        RCP3PD_MIDYR_CONC: RCP3PD_MIDYR_CONC
                        RCP45_MIDYR_CONC: RCP45_MIDYR_CONC
                        RCP6_MIDYR_CONC: RCP6_MIDYR_CONC
                        RCP85_MIDYR_CONC: RCP85_MIDYR_CONC
        "cmip6":
                add_forcing_files:
                        # Add CO2 etc for all scenarios and years
                        CMIP6DATA: CMIP6DATA
                        
                add_namelist_changes:
                        fort.4:
                                NAERAD:
                                        LCMIP6: ".true."
                                        CMIP6DATADIR: "${cmip6_data_dir_nml}"
                choose_scenario:
                        "piControl":                                
                                add_namelist_changes:
                                        fort.4:
                                                NAERAD:
                                                        NCMIPFIXYR: 1850
                        "SSP5-8.5":
                                add_namelist_changes:
                                        fort.4:
                                                NAERAD:
                                                        SSPNAME: "SSP5-8.5"
                                

#choose_o3_scheme:
#        "prescribed":
#                choose_mip:
#                        "cmip6":
#                                choose_scenario:
#                                        "piControl":
#                                                add_forcing_files:
#                                                        # O3 concentrations for piControl
#                                                        O3PI: O3PI
#                                        "historical":
#                                                add_forcing_files:
#                                                        # Add historical O3
#                                                        O3HIST: O3HIST
#                                        "SSP5-8.5":
#                                                add_forcing_files:
#                                                        # Add O3 for all scenarios
#                                                        O3SCEN: O3SCEN


##
## sources
##

input_sources:
        ICMGG_INIT: ${input_dir}/${prepifs_startdate}${hours}/ICMGG${prepifs_expid}INIT
        ICMGG_INIUA: ${input_dir}/${prepifs_startdate}${hours}/ICMGG${prepifs_expid}INIUA
        ICMSH_INIT: ${input_dir}/${prepifs_startdate}${hours}/ICMSH${prepifs_expid}INIT
        wam_grid_tables: ${input_dir}/${prepifs_startdate}${hours}/wam_grid_tables
        wam_subgrid_0: ${input_dir}/${prepifs_startdate}${hours}/wam_subgrid_0
        wam_subgrid_1: ${input_dir}/${prepifs_startdate}${hours}/wam_subgrid_1
        wam_subgrid_2: ${input_dir}/${prepifs_startdate}${hours}/wam_subgrid_2
        uwavein: ${input_dir}/${prepifs_startdate}${hours}/uwavein
        specwavein: ${input_dir}/${prepifs_startdate}${hours}/specwavein
        sfcwindin: ${input_dir}/${prepifs_startdate}${hours}/sfcwindin
        cdwavein: ${input_dir}/${prepifs_startdate}${hours}/cdwavein
        rtables: ${rtables_dir}/*
        vtables: ${vtables_dir}/*
        ifsdata: ${ifsdata_dir}/*
        tl_data: ${input_dir}/${res_number_tl}/*
        o3_data: ${input_dir}/${res_number_tl}/o3chem_l${nlev}/*

forcing_sources:
        # GHG data
        PRE2005_MIDYR_CONC: ${cmip5_data_dir}/PRE2005_MIDYR_CONC.txt
        RCP3PD_MIDYR_CONC: ${cmip5_data_dir}/RCP3PD_MIDYR_CONC.txt
        RCP45_MIDYR_CONC: ${cmip5_data_dir}/RCP45_MIDYR_CONC.txt
        RCP6_MIDYR_CONC: ${cmip5_data_dir}/RCP6_MIDYR_CONC.txt
        RCP85_MIDYR_CONC: ${cmip5_data_dir}/RCP85_MIDYR_CONC.txt
        # CMIP6
        CMIP6DATA: ${cmip6_data_dir}/*
        O3PI: ${cmip6_data_dir}/o3_pi/*
        O3HIST: ${cmip6_data_dir}/o3_histo/*
        O3SCEN: ${cmip6_data_dir}/o3_scenarios/*
        # ICMCL
        ICMCL_INIT: ${icmcl_dir}/${icmcl_file}



config_sources:
        "fort.4": "${namelist_dir}/pictl/fort.4"

input_in_work:
        ICMGG_INIT: ICMGG${oifs.input_expid}INIT
        ICMGG_INIUA: ICMGG${oifs.input_expid}INIUA
        ICMSH_INIT: ICMSH${oifs.input_expid}INIT
        ifs_xml: ifs_xml/*
        iodef_xml: iodef.xml
        context_xml: context_ifs.xml
        rtables: rtables/*
        vtables: vtables/*
        ifsdata: ifsdata/*
        tl_data: ${res_number_tl}/*
        o3_data: ${res_number_tl}/o3chem_l${nlev}/*

forcing_in_work:
        ICMCL_INIT: ICMCL${oifs.input_expid}INIT
        PRE2005_MIDYR_CONC: PRE2005_MIDYR_CONC.txt
        RCP3PD_MIDYR_CONC: RCP3PD_MIDYR_CONC.txt
        RCP45_MIDYR_CONC: RCP45_MIDYR_CONC.txt
        RCP6_MIDYR_CONC: RCP6_MIDYR_CONC.txt
        RCP85_MIDYR_CONC: RCP85_MIDYR_CONC.txt
        CMIP6DATA: cmip6_data/* 
        O3PI: cmip6_data/o3_pi/* 
        O3HIST: cmip6_data/o3_histo/* 
        O3SCEN: cmip6_data/o3_scenarios/*
        
##
## coupling
##

# split fields to A, R and L grid
# A grid is wet points except lakes
# L grid is wet points including lakes
# R grid is dry points 
foci_fields_a: [A_QsrMix, A_QnsMix, ATotRain] 
foci_fields_l: [AIceFrac, A_SSTSST, A_TepIce, A_IceTck, A_SnwTck, A_OCurx1, A_OCury1, A_OTaux1, A_OTauy1, A_ITaux1, A_ITauy1, A_QsrIce, A_QnsIce, ATotSnow, AIceEvap, A_dQnsdT]
foci_fields_r: [A_Runoff]

coupling_fields:
        "[[foci_fields_a-->FIELD]]":
                grid: atma
        "[[foci_fields_l-->FIELD]]":
                grid: atml
        "[[foci_fields_r-->FIELD]]":
                grid: atmr

# A grid at N80 resolution is A080 etc.
grids:
        atma:
                name: ${oasis_grid_name_a}
                nx: "${nx}"
                ny: "${ny}"
                oasis_grid_type: "D"
        atml:
                name: ${oasis_grid_name_l}
                nx: "${nx}"
                ny: "${ny}"
                oasis_grid_type: "D"
        atmr:
                name: ${oasis_grid_name_r}
                nx: "${nx}"
                ny: "${ny}"
                oasis_grid_type: "D"     
   
choose_output:
        "default":
                add_namelist_changes:
                        fort.4:
                                NAMCT0:
                                        NFRPOS: "$(( 3600 / ${time_step} * 6 ))"
                                        NFRHIS: "$(( 3600 / ${time_step} * 6 ))"

        "12hr":
                add_namelist_changes:
                        fort.4:
                                NAMCT0:
                                        NFRPOS: 12
                                        NFRHIS: 12


preprocess:
        preprocess_shell:
                method: "${general.esm_namelist_dir}/../configs/components/oifs/oifs-43r3-preprocess.sh ${input_dir}/${prepifs_startdate}${hours}/ ${icmcl_dir}/${icmcl_file} ${prepifs_expid} ${input_expid} ${start_date!syear!smonth!sday} ${icmcl_end_date_formatted} ${work_dir} ${wam_number} ${perturb} ${nx} ${ensemble_id}"
                type: shell
# postprocessing is not supported, and causes a crash in release 5 if not commented
# seb-wahl 2020-11-27
#postprocess:
#        postprocess_shell:
#                method: "${general.esm_namelist_dir}/../configs/components/oifs/oifs-43r3-postprocess.sh ${work_dir} ECE3 ${start_date!syear!smonth!sday} ${end_date!syear!smonth!sday}"
#                type: shell
compute_recipe:
   - "venv_bootstrap"
   - "_create_setup_folders"
   - "_create_component_folders"
   - "initialize_experiment_logfile"
   - "copy_tools_to_thisrun"
   - "compile_model"
   - "_copy_preliminary_files_from_experiment_to_thisrun"
   - "_show_simulation_info"
   - "create_new_files"
   - "prepare_coupler_files"
   - "add_batch_hostfile"
   - "assemble"
   - "log_used_files"
   - "_write_finalized_config"
   - "copy_files_to_thisrun"
   - "preprocess"
   - "modify_namelists"
   - "modify_files"
   - "copy_files_to_work"
   - "write_simple_runscript"
   - "report_missing_files"
   - "database_entry"
   - "submit"

